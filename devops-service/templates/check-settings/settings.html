{% extends "base.html" %}

{% block title %}Шаблонизация{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Справка</h5>
            </div>
            <div class="card-body">
                <p><strong>Jinja2:</strong> Проверяет синтаксис шаблона, находит неопределенные переменные и ошибки рендеринга.</p>
                <p><strong>Helm:</strong> Проверяет YAML синтаксис, валидирует Helm директивы и структуру Chart.</p>
                <p class="mb-0"><small class="text-muted">Тип шаблона определяется автоматически. Введите значения переменных в формате JSON для рендеринга шаблона.</small></p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-code me-2"></i>Шаблонизация</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="templateContent" class="form-label">Вставьте код шаблона</label>
                    <textarea class="form-control font-monospace" id="templateContent" rows="20" placeholder="Вставьте код шаблона здесь (Jinja2 или Helm)..."></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-key me-2"></i>Значения переменных</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="templateVariables" class="form-label">JSON с переменными</label>
                    <textarea class="form-control font-monospace" id="templateVariables" rows="15" placeholder='{"variable1": "value1", "variable2": "value2"}'></textarea>
                    <small class="form-text text-muted">Введите значения переменных в формате JSON</small>
                </div>
                <button class="btn btn-primary w-100" id="renderAndValidateBtn">
                    <i class="fas fa-play me-2"></i>Рендерить и проверить
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <!-- Результаты валидации -->
        <div id="validationResults" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-clipboard-check me-2"></i>Результаты проверки</h6>
                </div>
                <div class="card-body">
                    <div id="validationOutput"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const renderAndValidateBtn = document.getElementById('renderAndValidateBtn');
    const templateContent = document.getElementById('templateContent');
    const templateVariables = document.getElementById('templateVariables');
    const validationResults = document.getElementById('validationResults');
    const validationOutput = document.getElementById('validationOutput');
    
    // Рендеринг и валидация
    renderAndValidateBtn.addEventListener('click', async function() {
        const content = templateContent.value.trim();
        if (!content) {
            alert('Пожалуйста, введите код шаблона для проверки');
            return;
        }
        
        // Парсим переменные (если указаны)
        let variables = {};
        const variablesText = templateVariables.value.trim();
        if (variablesText) {
            try {
                variables = JSON.parse(variablesText);
            } catch (e) {
                alert('Ошибка в формате JSON переменных: ' + e.message);
                return;
            }
        }
        
        renderAndValidateBtn.disabled = true;
        renderAndValidateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Рендеринг и проверка...';
        
        try {
            // Сначала рендерим шаблон с переменными
            let renderedContent = content;
            if (Object.keys(variables).length > 0) {
                try {
                    // Используем простой рендеринг через замену (для базовых случаев)
                    // Для полноценного рендеринга нужен серверный endpoint
                    renderedContent = await renderTemplate(content, variables);
                } catch (renderError) {
                    console.warn('Ошибка рендеринга:', renderError);
                    // Продолжаем с оригинальным контентом
                }
            }
            
            // Валидируем шаблон
            const response = await fetch('/settings/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: renderedContent,
                    template_type: null  // Автоопределение
                })
            });
            
            const result = await response.json();
            displayValidationResults(result, 'template', content, renderedContent, variables);
        } catch (error) {
            showError('Ошибка при проверке кода: ' + error.message);
        } finally {
            renderAndValidateBtn.disabled = false;
            renderAndValidateBtn.innerHTML = '<i class="fas fa-play me-2"></i>Рендерить и проверить';
        }
    });
    
    // Функция для рендеринга шаблона на сервере
    async function renderTemplate(template, variables) {
        const response = await fetch('/settings/render', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                template: template,
                variables: variables
            })
        });
        
        if (!response.ok) {
            throw new Error('Ошибка рендеринга шаблона');
        }
        
        const result = await response.json();
        return result.rendered || template;
    }
    
    function displayValidationResults(result, filename, originalTemplate, renderedTemplate, variables) {
        validationResults.style.display = 'block';
        
        const validation = result.validation || {};
        const isValid = validation.valid !== false;
        
        let html = `
            <div class="alert alert-${isValid ? 'success' : 'danger'}">
                <h6>
                    <i class="fas fa-${isValid ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${isValid ? 'Шаблон валиден' : 'Найдены ошибки'}
                </h6>
                <p class="mb-0"><strong>Тип:</strong> ${result.type || 'не определен'}</p>
        `;
        
        // Показываем информацию о рендеринге, если были переменные
        if (variables && Object.keys(variables).length > 0) {
            html += `<p class="mb-0"><strong>Использованы переменные:</strong> ${Object.keys(variables).join(', ')}</p>`;
            if (renderedTemplate && renderedTemplate !== originalTemplate) {
                html += `
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#renderedOutput">
                            <i class="fas fa-eye me-2"></i>Показать отрендеренный результат
                        </button>
                    </div>
                    <div class="collapse mt-2" id="renderedOutput">
                        <pre class="bg-light p-3 rounded"><code>${escapeHtml(renderedTemplate)}</code></pre>
                    </div>
                `;
            }
        }
        
        html += `</div>`;
        
        // Ошибки
        if (validation.errors && validation.errors.length > 0) {
            html += '<div class="alert alert-danger"><h6><i class="fas fa-times-circle me-2"></i>Ошибки:</h6><ul class="mb-0">';
            validation.errors.forEach(error => {
                const errorMsg = typeof error === 'string' ? error : error.message || JSON.stringify(error);
                const line = error.line ? ` (строка ${error.line})` : '';
                html += `<li>${errorMsg}${line}</li>`;
            });
            html += '</ul></div>';
        }
        
        // Предупреждения
        if (validation.warnings && validation.warnings.length > 0) {
            html += '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle me-2"></i>Предупреждения:</h6><ul class="mb-0">';
            validation.warnings.forEach(warning => {
                const warningMsg = typeof warning === 'string' ? warning : warning.message || JSON.stringify(warning);
                html += `<li>${warningMsg}</li>`;
            });
            html += '</ul></div>';
        }
        
        // Дополнительная информация
        if (validation.variables && validation.variables.length > 0) {
            html += `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Найденные переменные:</h6>
                    <p class="mb-0"><code>${validation.variables.join(', ')}</code></p>
                </div>
            `;
        }
        
        if (validation.syntax_ok) {
            html += '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Синтаксис шаблона корректен</div>';
        }
        
        if (validation.is_yaml) {
            html += '<div class="alert alert-success"><i class="fas fa-check me-2"></i>YAML синтаксис корректен</div>';
        }
        
        if (validation.has_helm_directives) {
            html += '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Обнаружены Helm директивы</div>';
        }
        
        validationOutput.innerHTML = html;
        
        // Прокрутка к результатам
        validationResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function showError(message) {
        validationResults.style.display = 'block';
        validationOutput.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
            </div>
        `;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %} 