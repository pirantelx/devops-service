{% extends "base.html" %}

{% block title %}Чат с ИИ{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
    }
    .message {
        margin: 10px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
    }
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .ai-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
    }
    .chat-input {
        border-top: 1px solid #dee2e6;
        padding: 15px;
        background-color: white;
    }
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-robot me-2"></i>Чат с ИИ</h2>
            </div>
            <div class="card-body p-0">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <strong>ИИ:</strong> Привет! Я готов помочь вам с вопросами по DevOps, автоматизации и управлению инфраструктурой. Что вас интересует?
                    </div>
                </div>
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Введите ваш вопрос..." autocomplete="off">
                        <button class="btn btn-primary" type="button" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        ИИ печатает...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lightbulb me-2"></i>Примеры вопросов</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <button class="list-group-item list-group-item-action example-question">
                        Как настроить CI/CD pipeline?
                    </button>
                    <button class="list-group-item list-group-item-action example-question">
                        Какие лучшие практики для Docker контейнеризации?
                    </button>
                    <button class="list-group-item list-group-item-action example-question">
                        Как мониторить производительность системы?
                    </button>
                    <button class="list-group-item list-group-item-action example-question">
                        Рекомендации по безопасности инфраструктуры
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>История чата</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">История ваших разговоров с ИИ будет сохраняться здесь.</p>
                <a href="/ai-chat/history" class="btn btn-outline-primary">
                    <i class="fas fa-history me-2"></i>Просмотреть историю
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    
    // Примеры вопросов
    document.querySelectorAll('.example-question').forEach(button => {
        button.addEventListener('click', function() {
            messageInput.value = this.textContent;
            sendMessage();
        });
    });
    
    // Отправка сообщения по Enter
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Отправка сообщения по кнопке
    sendButton.addEventListener('click', sendMessage);
    
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Добавляем сообщение пользователя
        addMessage(message, 'user');
        messageInput.value = '';
        sendButton.disabled = true;
        
        // Показываем индикатор печати
        typingIndicator.style.display = 'block';
        
        try {
            // Отправляем запрос на сервер
            const response = await fetch('/ai-chat/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            // Скрываем индикатор печати
            typingIndicator.style.display = 'none';
            
            if (data.status === 'success') {
                addMessage(data.response, 'ai');
            } else {
                addMessage('Извините, произошла ошибка при обработке вашего запроса.', 'ai');
                console.error('Ошибка:', data);
            }
        } catch (error) {
            typingIndicator.style.display = 'none';
            addMessage('Ошибка соединения с сервером. Проверьте подключение к интернету.', 'ai');
            console.error('Ошибка:', error);
        } finally {
            sendButton.disabled = false;
        }
    }
    
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        // Экранируем HTML для безопасности
        const textEscaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        messageDiv.innerHTML = `<strong>${sender === 'user' ? 'Вы' : 'ИИ'}:</strong> ${textEscaped}`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>
{% endblock %} 